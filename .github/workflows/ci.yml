name: Java CI with Allure Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

    strategy:
      fail-fast: true
      matrix:
        browser: [chrome, firefox]  # Matrix for running tests in both Chrome and Firefox
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'
      - name: Install browsers
        run: |
          sudo apt-get update -y
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            sudo apt-get install -y wget gnupg2
            wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
            sudo apt-get update -y
            sudo apt-get install -y google-chrome-stable
          else
            sudo apt-get install -y firefox
          fi

      - name: Clean previous Allure results
        run: |
         rm -rf target/allure-results-${{ matrix.browser }}
          
      - name: Run tests (matrix)
        env:
         ALLURE_RESULTS_DIR: target/allure-results-${{ matrix.browser }}
        run: |
         echo "Running tests on browser=${{ matrix.browser }}"
         mvn -B -DskipTests=false -Dbrowser=${{ matrix.browser }} -Dallure.results.directory=${ALLURE_RESULTS_DIR} test
         TEST_RESULT=$?
         if [ $TEST_RESULT -ne 0 ]; then
          echo "Tests failed on browser=${{ matrix.browser }}. Failing the job."
          exit 1
         fi
    
      - name: Install Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version
      - name: Generate Allure HTML report
        run: |
         rm -rf allure-report-${{ matrix.browser }}
         allure generate target/allure-results-${{ matrix.browser }} --clean -o allure-report-${{ matrix.browser }}

      - name: Upload Allure report as artifact for ${{ matrix.browser }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.browser }}
          path: allure-report-${{ matrix.browser }}
          
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: success()  # Only run if all test matrix jobs succeed

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Deployment Script
        run: bash ./scripts/deploy.sh

      - name: Run Health Check
        run: bash ./scripts/healthcheck.sh || bash ./scripts/rollback.sh
        

  notify:
    name: Send Email Notification
    runs-on: ubuntu-latest
    needs: [test, deploy]  # Wait for these to finish
    if: always()  # Run whether pass or fail

    steps:
      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: >
            GitHub Actions - ${{ github.workflow }} - ${{ job.status }} ✅❌
          to: ${{ secrets.EMAIL_RECEIVER }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            ✅ GitHub Actions workflow has completed!

            • Repository: ${{ github.repository }}
            • Workflow: ${{ github.workflow }}
            • Status: ${{ job.status }}
            • Branch: ${{ github.ref }}
            • Commit: ${{ github.sha }}
            • Run Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

           



